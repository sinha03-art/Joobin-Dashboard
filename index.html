<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JOOBIN Command Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #2c3e50; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .header .subtitle { font-size: 14px; opacity: 0.9; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; max-width: 1400px; margin: 0 auto; }
        .kpi-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .kpi-label { font-size: 12px; color: #7f8c8d; text-transform: uppercase; margin-bottom: 8px; }
        .kpi-value { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .kpi-icon { float: right; font-size: 32px; opacity: 0.3; }
        .tabs { display: flex; justify-content: center; background: white; padding: 10px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); gap: 10px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; cursor: pointer; border-radius: 5px; transition: all 0.3s; font-weight: 500; }
        .tab:hover { background: #ecf0f1; }
        .tab.active { background: #667eea; color: white; }
        .content { padding: 20px; max-width: 1400px; margin: 0 auto; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; z-index: 999; }
        .activity-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #3498db; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .activity-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .activity-type { font-weight: bold; color: #2c3e50; }
        .activity-time { font-size: 12px; color: #95a5a6; }
        .activity-description { color: #555; margin-bottom: 5px; }
        .activity-company { font-size: 12px; color: #7f8c8d; font-style: italic; }
        .gate-progress { background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .gate-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gate-name { font-size: 18px; font-weight: bold; color: #2c3e50; }
        .gate-status { padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-overdue { background: #f8d7da; color: #721c24; }
        .progress-bar { background: #ecf0f1; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold; }
        .deliverable-list { margin-top: 10px; font-size: 13px; }
        .deliverable-item { padding: 5px 0; color: #555; border-bottom: 1px solid #ecf0f1; }
        .deliverable-item:last-child { border-bottom: none; }
        .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .vendor-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .vendor-card { background: white; padding: 15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #3498db; }
        .vendor-name { font-weight: bold; color: #2c3e50; margin-bottom: 8px; }
        .vendor-amount { font-size: 20px; color: #27ae60; font-weight: bold; }
        .vendor-status { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèóÔ∏è JOOBIN RENOVATION COMMAND CENTER</h1>
        <div class="subtitle" id="current-time">Loading...</div>
    </div>

    <div id="loading">‚è≥ Loading dashboard...</div>

    <div id="app">
        <div class="kpi-grid" id="kpi-container"></div>
        <div class="tabs" id="tabs-container"></div>
        <div class="content" id="content-container"></div>
    </div>

    <div id="password-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
            <h3 style="margin-top: 0; color: #2c3e50;">üîí Authorization Required</h3>
            <p style="color: #666; margin-bottom: 20px;">Enter password to approve this action:</p>
            <input 
                type="password" 
                id="update-password" 
                placeholder="Enter password"
                style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; margin-bottom: 20px; box-sizing: border-box;"
            />
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button 
                    onclick="cancelUpdate()"
                    style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;"
                >
                    Cancel
                </button>
                <button 
                    onclick="executeUpdate()"
                    style="padding: 10px 20px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;"
                >
                    ‚úÖ Confirm
                </button>
            </div>
        </div>
    </div>

    <script>
        // Format currency
        function formatMYR(amount) {
            if (amount === null || amount === undefined) return 'RM 0.00';
            return 'RM ' + Number(amount).toLocaleString('en-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-MY', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Time ago helper
        function timeAgo(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            const weeks = Math.floor(days / 7);
            if (weeks < 4) return `${weeks}w ago`;
            const months = Math.floor(days / 30);
            return `${months}mo ago`;
        }

        // Normalize values for safe comparison
        function norm(val) {
            if (val === null || val === undefined) return 0;
            if (typeof val === 'number') return val;
            if (typeof val === 'string') {
                const cleaned = val.replace(/[^0-9.-]/g, '');
                const num = parseFloat(cleaned);
                return isNaN(num) ? 0 : num;
            }
            return 0;
        }

        // Render KPIs
        function renderKPIs(kpis) {
            const container = document.getElementById('kpi-container');
            if (!kpis) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No KPI data available</p>';
                return;
            }

            const kpiCards = [
                { label: 'Total Budget', value: formatMYR(kpis.totalBudget), icon: 'üí∞' },
                { label: 'Total Paid', value: formatMYR(kpis.totalPaid), icon: 'üí≥' },
                { label: 'Remaining Budget', value: formatMYR(kpis.remainingBudget), icon: 'üìä' },
                { label: 'Approved Gates', value: `${kpis.approvedGates || 0} / ${kpis.totalGates || 6}`, icon: '‚úÖ' },
                { label: 'Completed Deliverables', value: `${kpis.completedDeliverables || 0} / ${kpis.totalDeliverables || 0}`, icon: 'üì¶' },
                { label: 'Overdue Items', value: kpis.overdueCount || 0, icon: '‚ö†Ô∏è' },
                { label: 'Active Vendors', value: kpis.activeVendors || 0, icon: 'üè¢' }
            ];

            container.innerHTML = kpiCards.map(kpi => `
                <div class="kpi-card">
                    <div class="kpi-icon">${kpi.icon}</div>
                    <div class="kpi-label">${kpi.label}</div>
                    <div class="kpi-value">${kpi.value}</div>
                </div>
            `).join('');
        }

        // Render tabs
        function renderTabs() {
            const tabs = [
                { id: 'activity', label: 'üìã Recent Activity', icon: 'üìã' },
                { id: 'gates', label: 'üéØ Gate Progress', icon: 'üéØ' },
                { id: 'vendors', label: 'üè¢ Top Vendors', icon: 'üè¢' },
                { id: 'charts', label: 'üìä Charts', icon: 'üìä' }
            ];

            const container = document.getElementById('tabs-container');
            container.innerHTML = tabs.map((tab, index) => `
                <div class="tab ${index === 0 ? 'active' : ''}" data-tab="${tab.id}">
                    ${tab.label}
                </div>
            `).join('');

            // Add click handlers
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    switchTab(tab.dataset.tab);
                });
            });
        }

        // Switch tab content
        function switchTab(tabId) {
            const data = window.dashboardData;
            if (!data) return;

            switch(tabId) {
                case 'activity':
                    renderActivity(data.recentActivity || []);
                    break;
                case 'gates':
                    renderGates(data.gates || []);
                    break;
                case 'vendors':
                    renderTopVendors(data.topVendors || []);
                    break;
                case 'charts':
                    renderCharts(data);
                    break;
            }
        }

        // Render activity feed
        function renderActivity(activities) {
            const container = document.getElementById('content-container');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No recent activity</p>';
                return;
            }

            const getIcon = (type) => {
                const icons = {
                    'Deliverable Submitted': 'üì§',
                    'Gate Approved': '‚úÖ',
                    'Payment Made': 'üí≥',
                    'Document Updated': 'üìù',
                    'Review Completed': 'üëÅÔ∏è',
                    'Status Changed': 'üîÑ',
                    'Comment Added': 'üí¨',
                    'File Uploaded': 'üìé'
                };
                return icons[type] || 'üìã';
            };

            const getColor = (type) => {
                const colors = {
                    'Deliverable Submitted': '#3498db',
                    'Gate Approved': '#27ae60',
                    'Payment Made': '#9b59b6',
                    'Document Updated': '#f39c12',
                    'Review Completed': '#1abc9c',
                    'Status Changed': '#e74c3c',
                    'Comment Added': '#34495e',
                    'File Uploaded': '#16a085'
                };
                return colors[type] || '#95a5a6';
            };

            container.innerHTML = activities.map(activity => `
                <div class="activity-item" style="border-left-color: ${getColor(activity.type)}">
                    <div class="activity-header">
                        <div class="activity-type">${getIcon(activity.type)} ${activity.type}</div>
                        <div class="activity-time">${timeAgo(activity.timestamp)}</div>
                    </div>
                    <div class="activity-description">${activity.description || 'No description'}</div>
                    ${activity.company ? `<div class="activity-company">üè¢ ${activity.company}</div>` : ''}
                </div>
            `).join('');
        }

        // Render gate progress
        function renderGates(gates) {
            const container = document.getElementById('content-container');
            
            if (!gates || gates.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No gate data available</p>';
                return;
            }

            container.innerHTML = gates.map(gate => {
                const percentage = gate.totalRequired > 0 
                    ? Math.round((gate.completed / gate.totalRequired) * 100) 
                    : 0;
                
                let statusClass = 'status-pending';
                let statusText = 'Pending';
                
                if (gate.status === 'Approved') {
                    statusClass = 'status-approved';
                    statusText = '‚úÖ Approved';
                } else if (gate.isOverdue) {
                    statusClass = 'status-overdue';
                    statusText = '‚ö†Ô∏è Overdue';
                }

                return `
                    <div class="gate-progress">
                        <div class="gate-header">
                            <div class="gate-name">${gate.name}</div>
                            <div class="gate-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%">
                                ${percentage > 10 ? percentage + '%' : ''}
                            </div>
                        </div>
                        <div style="font-size: 13px; color: #7f8c8d; margin-bottom: 10px;">
                            ${gate.completed} of ${gate.totalRequired} deliverables completed
                        </div>
                        ${gate.deliverables && gate.deliverables.length > 0 ? `
                            <div class="deliverable-list">
                                <strong>Required Deliverables:</strong>
                                ${gate.deliverables.map(d => `
                                    <div class="deliverable-item">
                                        ${d.completed ? '‚úÖ' : '‚è≥'} ${d.name}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Render top vendors
        function renderTopVendors(vendors) {
            const container = document.getElementById('content-container');
            
            if (!vendors || vendors.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No vendor data available</p>';
                return;
            }

            container.innerHTML = `
                <div class="vendor-list">
                    ${vendors.map(vendor => `
                        <div class="vendor-card">
                            <div class="vendor-name">üè¢ ${vendor.name || 'Unknown Vendor'}</div>
                            <div class="vendor-amount">${formatMYR(vendor.amount)}</div>
                            <div class="vendor-status">
                                ${vendor.invoiceCount || 0} invoice${vendor.invoiceCount !== 1 ? 's' : ''}
                                ${vendor.status ? `‚Ä¢ ${vendor.status}` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Render charts
        function renderCharts(data) {
            const container = document.getElementById('content-container');
            
            container.innerHTML = `
                <div class="chart-container">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">üí∞ Budget Overview</h3>
                    <canvas id="budgetChart" style="max-height: 400px;"></canvas>
                </div>
            `;

            // Create budget chart
            const ctx = document.getElementById('budgetChart').getContext('2d');
            
            const totalBudget = norm(data.kpis?.totalBudget);
            const totalPaid = norm(data.kpis?.totalPaid);
            const remaining = totalBudget - totalPaid;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Paid', 'Remaining'],
                    datasets: [{
                        data: [totalPaid, remaining > 0 ? remaining : 0],
                        backgroundColor: ['#667eea', '#ecf0f1'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: { size: 14 },
                                color: '#FFFFFF'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = formatMYR(context.parsed);
                                    const percentage = totalBudget > 0 
                                        ? ((context.parsed / totalBudget) * 100).toFixed(1) 
                                        : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize dashboard
        async function init() {
            try {
                updateClock();
                setInterval(updateClock, 1000);
                
                showLoading();
                
                const response = await fetch('/.netlify/functions/proxy');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Dashboard data loaded:', data);
                
                // Store data globally
                window.dashboardData = data;
                
                // Render KPIs
                renderKPIs(data.kpis);
                
                // Set up tabs
                renderTabs();
                
                // Render initial content (Activity tab)
                renderActivity(data.recentActivity || []);
                
                hideLoading();
                
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                hideLoading();
                document.getElementById('app').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2>‚ö†Ô∏è Failed to Load Dashboard</h2>
                        <p style="color: #666;">${error.message}</p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Show loading state
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('app').style.opacity = '0.3';
        }

        // Hide loading state
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').style.opacity = '1';
        }

        // Update clock in header
        function updateClock() {
            const now = new Date();
            const options = { 
                timeZone: 'Asia/Kuala_Lumpur',
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            const timeString = now.toLocaleString('en-MY', options);
            document.getElementById('current-time').textContent = timeString;
        }

        // Prompt for update password
        async function promptForUpdate(action, itemId) {
            const modal = document.getElementById('password-modal');
            const input = document.getElementById('update-password');
            
            // Store action details
            window.pendingUpdate = { action, itemId };
            
            // Show modal
            modal.style.display = 'flex';
            input.value = '';
            input.focus();
        }

        // Execute the pending update
        async function executeUpdate() {
            const password = document.getElementById('update-password').value;
            const { action, itemId } = window.pendingUpdate;
            
            if (!password) {
                alert('Please enter a password');
                return;
            }
            
            try {
                showLoading();
                
                const response = await fetch('/.netlify/functions/proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action,
                        itemId,
                        password
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Update failed');
                }
                
                // Close modal
                cancelUpdate();
                
                // Show success message
                alert('‚úÖ ' + result.message);
                
                // Reload dashboard
                location.reload();
                
            } catch (error) {
                hideLoading();
                alert('‚ùå ' + error.message);
            }
        }

        // Cancel update
        function cancelUpdate() {
            document.getElementById('password-modal').style.display = 'none';
            document.getElementById('update-password').value = '';
            window.pendingUpdate = null;
        }

        // Allow Enter key in password modal
        document.getElementById('update-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                executeUpdate();
            }
        });

        // Get AI summary from backend
        async function getAISummary(context) {
            try {
                const response = await fetch('/.netlify/functions/proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'get_ai_summary',
                        context
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to get AI summary');
                }
                
                const result = await response.json();
                return result.summary;
                
            } catch (error) {
                console.error('AI summary error:', error);
                return 'AI summary unavailable';
            }
        }

        // Start the app
        init();
    </script>
</body>
</html>