<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gate Deliverables â€” Board</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #111827; --panel: #1f2937; --border: #374151; --ink: #f9fafb;
      --muted: #9ca3af; --brand: #2563eb; --danger: #e11d48;
    }
    html, body { height: 100% }
    body { font-family: "Inter", system-ui; background: var(--bg); color: var(--ink); }
    .card-item {
      border: 1px solid var(--border); border-radius: .5rem; padding: .6rem .7rem;
      background: #374151; transition: box-shadow .15s ease, border-color .15s ease;
    }
    .card-item:hover { border-color: var(--brand); box-shadow: 0 4px 10px rgba(0,0,0,.1) }
    .badge { font-size: .7rem; padding: .15rem .45rem; border-radius: 999px; font-weight: 600 }
    .badge-Approved { background: #059669; color: #d1fae5 } .badge-Submitted { background: #d97706; color: #fef3c7 }
    .badge-Missing { background: #4b5563; color: #e5e7eb } .badge-Rejected { background: #dc2626; color: #fee2e2 }
    .sticky-header { position: sticky; top: 0; background: var(--bg); z-index: 10; padding: 1rem 0; border-bottom: 1px solid var(--border); }
    #ownerChips button.active { background: var(--brand); color: #fff; border-color: var(--brand) }
    /* --- NEW: Styles for Card Enhancements --- */
    .avatar {
      width: 24px; height: 24px; border-radius: 9999px; display: inline-flex;
      align-items: center; justify-content: center; font-size: 11px; font-weight: 600;
    }
    .text-overdue { color: var(--danger); }
    /* --- NEW: Styles for Password Modal --- */
    #passwordModal { transition: opacity 0.3s ease; }
    .modal-content { transition: transform 0.3s ease; }
  </style>
</head>

<body class="px-4 md:px-6">
  <header class="sticky-header">
     </header>
  
  <main id="root" class="mt-6 space-y-8 max-w-7xl mx-auto"></main>
  <div id="loader" class="text-center p-8 text-slate-400">Loading deliverables...</div>

  <div id="passwordModal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
      <div class="modal-content bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-sm transform scale-95">
          <h3 id="modalTitle" class="text-lg font-bold text-white mb-4">Authentication Required</h3>
          <p id="modalMessage" class="text-sm text-slate-400 mb-4">Please enter the update password to proceed.</p>
          <input type="password" id="passwordInput" class="w-full p-2 rounded bg-slate-700 text-white border border-slate-600 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Password...">
          <div id="passwordError" class="text-red-400 text-xs mt-2 hidden">Incorrect password.</div>
          <div class="flex justify-end gap-3 mt-6">
              <button onclick="cancelUpdate()" class="px-4 py-2 text-sm font-medium text-slate-300 bg-slate-700 rounded-md hover:bg-slate-600">Cancel</button>
              <button onclick="executeUpdate()" id="executeUpdateBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-500">
                  <span id="updateBtnText">Confirm</span>
                  <span id="updateBtnSpinner" class="hidden">Updating...</span>
              </button>
          </div>
      </div>
  </div>

  <script>
    const API_URL = '/.netlify/functions/proxy'; // NEW: API URL constant
    const STATUS_ORDER = ['Missing', 'Submitted', 'Rejected', 'Approved'];
    const STATUS_TITLES = { Missing: 'Missing', Submitted: 'Submitted', Rejected: 'Rejected', Approved: 'Approved' };
    let dataCache;
    let ownerFilter = '';
    let pendingUpdate = { action: null, gateName: null }; // NEW: State for updates

    // Unchanged helper functions
    function norm(s) { return String(s || '').trim().toLowerCase(); }
    function byGate(list) { const m = {}; list.forEach(d => { const g = d.gate || 'Uncategorized'; (m[g] ||= []).push(d); }); return m; }
    function byStatus(list) { const m = { Missing: [], Submitted: [], Rejected: [], Approved: [] }; list.forEach(d => { const s = STATUS_ORDER.includes(d.status) ? d.status : 'Missing'; m[s].push(d); }); return m; }
    function matchQuery(d, q) { if (!q) return true; const t = (d.title || '').toLowerCase(); const owners = (d.assignees || []).join(' ').toLowerCase(); return t.includes(q) || owners.includes(q); }

    // --- NEW: Helper Functions for Avatars and Dates ---
    const getInitials = (name = '') => name.split(' ').map(n => n[0]).join('').toUpperCase();
    const avatarColor = (name = '') => { const colors = ['#fb923c', '#f87171', '#fbbf24', '#a78bfa', '#60a5fa']; const charCodeSum = [...name].reduce((sum, char) => sum + char.charCodeAt(0), 0); return colors[charCodeSum % colors.length]; }
    const formatDate = (d) => d ? new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';
    const isOverdue = (d, status) => d && new Date(d) < new Date() && status !== 'Approved';

    // --- UPDATED: Gate Header with "Approve All" Button ---
    function gateHeader(g, gateData) {
      const progress = gateData.total > 0 ? Math.round((gateData.approved / gateData.total) * 100) : 0;
      const isCompleted = progress === 100;
      return `
      <div class="flex flex-col md:flex-row md:items-end md:justify-between mb-3">
        <div class="flex items-center gap-4">
          <div>
            <h2 class="text-xl font-bold">${g}</h2>
            <p class="text-xs text-slate-400 mt-1">${gateData.approved} of ${gateData.total} approved</p>
          </div>
          <button 
            onclick="promptForUpdate(null, 'mark_gate_approved', '${g}')" 
            class="px-3 py-1 text-xs font-bold rounded-md transition-colors ${isCompleted ? 'bg-green-600 text-white cursor-default' : 'bg-blue-600 text-white hover:bg-blue-700'}"
            ${isCompleted ? 'disabled' : ''}>
            ${isCompleted ? 'âœ“ Approved' : 'Approve All'}
          </button>
        </div>
        <div class="w-full md:w-1/3 mt-2 md:mt-0">
          <div class="flex items-center gap-2 text-xs text-slate-400">
            <span>${progress}%</span>
            <div class="w-full bg-slate-700 rounded-full h-1.5"><div class="bg-blue-600 h-1.5 rounded-full" style="width: ${progress}%"></div></div>
          </div>
        </div>
      </div>
    `;
    }

    // --- UPDATED: Item Card with Avatars, Due Dates, and Priority ---
    function itemCard(d) {
      const owners = (d.assignees && d.assignees.length) ? d.assignees : [];
      const badgeClass = 'badge badge-' + (STATUS_ORDER.includes(d.status) ? d.status : 'Missing');
      const dueDate = formatDate(d.dueDate);
      const overdueClass = isOverdue(d.dueDate, d.status) ? 'text-overdue font-semibold' : 'text-slate-400';
      const highPriority = norm(d.priority) === 'high';

      return `
      <a href="${d.url}" target="_blank" class="card-item block">
        <div class="flex items-start justify-between gap-3">
            <p class="font-medium truncate text-sm flex-1">${d.title}</p>
            <span class="${badgeClass}">${d.status || 'Missing'}</span>
        </div>
        <div class="flex items-center justify-between mt-2 pt-2 border-t border-slate-600/50">
            <div class="flex items-center -space-x-2">
                ${owners.map(owner => `<div class="avatar" style="background-color:${avatarColor(owner)}; color: #fff" title="${owner}">${getInitials(owner)}</div>`).join('')}
                ${owners.length === 0 ? `<p class="text-xs text-slate-500">Unassigned</p>` : ''}
            </div>
            <div class="flex items-center gap-2 text-xs">
                ${highPriority ? `<span title="High Priority">ðŸ”¥</span>` : ''}
                <span class="${overdueClass}">${dueDate || 'No due date'}</span>
            </div>
        </div>
      </a>`;
    }

    // Unchanged render logic for columns
    function column(title, items) { /* ... same as before ... */ }
    
    // --- NEW: Functions to handle secure updates ---
    function promptForUpdate(pageId, action, gateName = null) {
      pendingUpdate = { pageId, action, gateName };
      document.getElementById('modalTitle').textContent = `Confirm Action: ${action.replace(/_/g, ' ')}`;
      document.getElementById('modalMessage').textContent = gateName ? `This will attempt to approve all deliverables for gate: ${gateName}.` : 'Please enter the update password to proceed.';
      document.getElementById('passwordModal').style.display = 'flex';
      setTimeout(() => { document.getElementById('passwordModal').style.opacity = 1; document.querySelector('#passwordModal .modal-content').style.transform = 'scale(1)'; }, 10);
      document.getElementById('passwordInput').focus();
    }

    function cancelUpdate() {
      document.getElementById('passwordModal').style.opacity = 0;
      document.querySelector('#passwordModal .modal-content').style.transform = 'scale(0.95)';
      setTimeout(() => { document.getElementById('passwordModal').style.display = 'none'; }, 300);
      document.getElementById('passwordInput').value = '';
      document.getElementById('passwordError').classList.add('hidden');
    }

    async function executeUpdate() {
      const password = document.getElementById('passwordInput').value;
      if (!password) {
          document.getElementById('passwordError').textContent = 'Password cannot be empty.';
          document.getElementById('passwordError').classList.remove('hidden');
          return;
      }
      document.getElementById('updateBtnText').classList.add('hidden');
      document.getElementById('updateBtnSpinner').classList.remove('hidden');
      document.getElementById('executeUpdateBtn').disabled = true;

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...pendingUpdate, password }),
        });
        if (response.ok) {
          cancelUpdate();
          document.getElementById('loader').style.display = 'block';
          root.innerHTML = '';
          load(); // Reload data on success
        } else {
          const err = await response.json();
          throw new Error(err.error || 'Update failed.');
        }
      } catch (error) {
        document.getElementById('passwordError').textContent = error.message;
        document.getElementById('passwordError').classList.remove('hidden');
      } finally {
        document.getElementById('updateBtnText').classList.remove('hidden');
        document.getElementById('updateBtnSpinner').classList.add('hidden');
        document.getElementById('executeUpdateBtn').disabled = false;
      }
    }
    
    // Filtering and initial load logic is mostly unchanged
    function setOwnerFilter(v) { /* ... same as before ... */ }
    function render() { /* ... same as before ... */ }

    async function load() {
      try {
        const res = await fetch(API_URL); // Updated to use constant
        if (!res.ok) throw new Error(`Failed to load data: ${res.statusText}`);
        dataCache = await res.json();
        document.getElementById('loader').style.display = 'none';
        const gatesFromData = (dataCache.gates || []).map(g => g.gate).sort();
        const sel = document.getElementById('gateFilter');
        sel.innerHTML = `<option value="">All gates</option>`;
        gatesFromData.forEach(g => sel.insertAdjacentHTML('beforeend', `<option>${g}</option>`));
        document.querySelectorAll('#ownerChips [data-owner]').forEach(btn => {
          btn.addEventListener('click', () => setOwnerFilter(btn.dataset.owner));
        });
        const urlGate = new URLSearchParams(location.search).get('gate');
        if (urlGate && gatesFromData.includes(urlGate)) { sel.value = urlGate; }
        const urlOwner = new URLSearchParams(location.search).get('owner');
        if (urlOwner) setOwnerFilter(urlOwner);
        render();
      } catch (err) { /* ... error handling is the same ... */ }
    }

    document.getElementById('q').addEventListener('input', render);
    document.getElementById('gateFilter').addEventListener('change', render);

    load();
  </script>
</body>

</html>