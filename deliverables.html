<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gate Deliverables ‚Äî Board v2.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
         :root {
            --bg: #111827;
            --panel: #1f2937;
            --border: #374151;
            --ink: #f9fafb;
            --muted: #9ca3af;
            --brand: #2563eb;
        }
        
        html,
        body {
            height: 100%
        }
        
        body {
            font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            background: var(--bg);
            color: var(--ink);
        }
        
        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: .75rem;
        }
        
        .col {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: .75rem;
            min-height: 180px;
        }
        
        .badge {
            font-size: .7rem;
            padding: .15rem .45rem;
            border-radius: 999px;
            font-weight: 600
        }
        
        /* NEW: Better status colors */
        .badge-Approved {
            background: #059669;
            color: #d1fae5
        }
        
        .badge-Submitted {
            background: #2563eb; /* Changed from orange */
            color: #dbeafe
        }
        
        .badge-Missing {
            background: #6b7280;
            color: #e5e7eb
        }
        
        .badge-Rejected {
            background: #dc2626;
            color: #fee2e2
        }
        
        .card-item {
            border: 1px solid var(--border);
            border-radius: .5rem;
            padding: .6rem .7rem;
            background: #374151;
            transition: box-shadow .15s ease, border-color .15s ease, transform .15s ease;
        }
        
        .card-item:hover {
            border-color: var(--brand);
            box-shadow: 0 4px 10px rgba(0, 0, 0, .1);
            transform: translateY(-2px);
        }
        
        .sticky-header {
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 10;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        #ownerChips button.active {
            background: var(--brand);
            color: #fff;
            border-color: var(--brand)
        }

        /* NEW: Skeleton loader */
        .skeleton {
            background: linear-gradient(90deg, #1f2937 25%, #374151 50%, #1f2937 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 0.5rem;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            height: 80px;
            margin-bottom: 0.5rem;
        }

        /* NEW: Search highlight */
        .highlight {
            background: #fbbf24;
            color: #111827;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        /* NEW: Export button */
        .export-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #059669;
            color: white;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .export-btn:hover {
            background: #047857;
        }

        /* NEW: Mobile responsive */
        @media (max-width: 768px) {
            .sticky-header {
                padding: 0.5rem 0;
            }

            #ownerChips {
                flex-wrap: wrap;
            }

            .col {
                min-height: 120px;
            }
        }

        /* NEW: Empty state animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .empty-state {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>

<body class="px-4 md:px-6">
    <header class="sticky-header">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 max-w-7xl mx-auto">
            <div class="flex items-center gap-4">
                <a href="index.html" title="Back to Command Center" class="p-2 rounded-md hover:bg-slate-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left">
                        <path d="m12 19-7-7 7-7" />
                        <path d="M19 12H5" />
                    </svg>
                </a>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">Gate Deliverables</h1>
                    <p class="text-sm text-slate-400">Track and manage all project deliverables by gate.</p>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <input id="q" class="px-3 py-2 rounded-md border text-sm w-40 bg-transparent border-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Search...">
                <select id="gateFilter" class="px-3 py-2 rounded-md border text-sm bg-transparent border-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All gates</option>
                </select>
                <div class="flex gap-2" id="ownerChips">
                    <button class="px-3 py-1 text-xs rounded-md border border-slate-700 hover:bg-slate-800" data-owner="solomon">Solomon</button>
                    <button class="px-3 py-1 text-xs rounded-md border border-slate-700 hover:bg-slate-800" data-owner="harminder">Harminder</button>
                    <button class="px-3 py-1 text-xs rounded-md border border-slate-700 hover:bg-slate-800 active" data-owner="">All</button>
                </div>
                <!-- NEW: Export button -->
                <button onclick="exportToCSV()" class="export-btn" title="Export deliverables to CSV">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="12" y1="18" x2="12" y2="12"/>
                        <line x1="9" y1="15" x2="15" y2="15"/>
                    </svg>
                    Export
                </button>
                <a href="https://opaque-alto-89e.notion.site/2865a80cd06780dda291d7d78c74ec3a?pvs=105" target="_blank" rel="noopener noreferrer" class="px-3 py-2 rounded-md bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 transition-colors">Upload Deliverable</a>
            </div>
        </div>
    </header>

    <!-- NEW: Skeleton Loader -->
    <div id="loader" class="mt-6 space-y-8 max-w-7xl mx-auto">
        <div>
            <div class="skeleton h-8 w-48 mb-4"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                <div class="col p-3">
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
                <div class="col p-3">
                    <div class="skeleton skeleton-card"></div>
                </div>
                <div class="col p-3">
                    <div class="skeleton skeleton-card"></div>
                </div>
                <div class="col p-3">
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
            </div>
        </div>
    </div>

    <main id="root" class="mt-6 space-y-8 max-w-7xl mx-auto hidden"></main>

    <script>
        const STATUS_ORDER = ['Missing', 'Submitted', 'Rejected', 'Approved'];
        const STATUS_TITLES = {
            Missing: 'Missing',
            Submitted: 'Submitted',
            Rejected: 'Rejected',
            Approved: 'Approved'
        };
        
        let dataCache;
        let ownerFilter = '';
        let searchDebounce = null;

        function norm(s) {
            return String(s || '').trim().toLowerCase();
        }

        function byGate(list) {
            const m = {};
            list.forEach(d => {
                const g = d.gate || 'Uncategorized';
                if (!m[g]) m[g] = [];
                m[g].push(d);
            });
            return m;
        }

        function byStatus(list) {
            const m = {
                Missing: [],
                Submitted: [],
                Rejected: [],
                Approved: []
            };
            list.forEach(d => {
                const s = STATUS_ORDER.includes(d.status) ? d.status : 'Missing';
                m[s].push(d);
            });
            return m;
        }

        function matchQuery(d, q) {
            if (!q) return true;
            const t = (d.title || '').toLowerCase();
            const owners = (d.assignees || []).join(' ').toLowerCase();
            return t.includes(q) || owners.includes(q);
        }

        // NEW: Highlight search terms
        function highlightText(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function gateHeader(g, gateData) {
            const progress = gateData.total > 0 ? Math.round((gateData.approved / gateData.total) * 100) : 0;
            const criticalProgress = gateData.criticalTotal > 0 ? Math.round((gateData.criticalApproved / gateData.criticalTotal) * 100) : 0;

            return `
    <div class="flex flex-col md:flex-row md:items-end md:justify-between mb-3">
      <div>
        <h2 class="text-xl font-bold">${g}</h2>
        <p class="text-xs text-slate-400 mt-1">
          Total: ${gateData.approved} of ${gateData.total} approved
          <span style="color: #dc2626; font-weight: 600; margin-left: 8px;">
            Critical: ${gateData.criticalApproved}/${gateData.criticalTotal}
          </span>
        </p>
      </div>
      <div class="w-full md:w-1/3 mt-2 md:mt-0">
        <div class="flex items-center gap-2 text-xs text-slate-400">
          <span>${progress}%</span>
          <div class="w-full bg-slate-700 rounded-full h-1.5">
            <div class="bg-blue-600 h-1.5 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
          </div>
        </div>
      </div>
    </div>
  `;
        }

        function itemCard(d, query = '') {
            const owners = (d.assignees && d.assignees.length) ? d.assignees.join(', ') : '‚Äî';
            const badgeClass = 'badge badge-' + (STATUS_ORDER.includes(d.status) ? d.status : 'Missing');

            const criticalBadge = d.isCritical ? '<span class="badge" style="background: #dc2626; color: #fff; margin-left: 4px;">CRITICAL</span>' : '';
            const cardStyle = d.isCritical ? 'border-left: 3px solid #dc2626;' : '';

            // Highlight search terms
            const titleHtml = highlightText(d.title, query);

            return `
    <a href="${d.url}" target="_blank" class="card-item block" style="${cardStyle}">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <p class="font-medium truncate text-sm">${titleHtml}</p>
          <p class="text-xs text-slate-400 mt-1">Assignees: ${owners}</p>
          ${d.dueDate ? `<p class="text-xs text-slate-500 mt-1">Due: ${new Date(d.dueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}</p>` : ''}
        </div>
        <div class="flex gap-2 flex-shrink-0">
          <span class="${badgeClass}">${d.status || 'Missing'}</span>
          ${criticalBadge}
        </div>
      </div>
    </a>
  `;
        }

        function column(title, items, query = '') {
            // NEW: Better empty state
            if (items.length === 0) {
                const emptyMessages = {
                    'Missing': { icon: '‚úÖ', text: 'All items tracked!' },
                    'Submitted': { icon: 'üì§', text: 'Nothing submitted yet' },
                    'Rejected': { icon: 'üéØ', text: 'No rejections!' },
                    'Approved': { icon: 'üéâ', text: 'Start approving!' }
                };
                
                const empty = emptyMessages[title] || { icon: 'üì≠', text: 'No items' };
                
                return `
                <div class="col p-3">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-xs font-bold text-slate-400">${title}</p>
                        <span class="text-xs text-slate-500">0</span>
                    </div>
                    <div class="empty-state text-center py-8">
                        <div class="text-3xl mb-2">${empty.icon}</div>
                        <p class="text-xs text-slate-500">${empty.text}</p>
                    </div>
                </div>
            `;
            }

            return `
      <div class="col p-3">
        <div class="flex items-center justify-between mb-2">
          <p class="text-xs font-bold text-slate-400">${title}</p>
          <span class="text-xs text-slate-500">${items.length}</span>
        </div>
        <div class="space-y-2">
          ${items.map(item => itemCard(item, query)).join('')}
        </div>
      </div>
    `;
        }

        function setOwnerFilter(v) {
            ownerFilter = (v || '').toLowerCase();
            document.querySelectorAll('#ownerChips [data-owner]').forEach(btn => {
                btn.classList.toggle('active', (btn.dataset.owner || '').toLowerCase() === ownerFilter);
            });
            render();
        }

        function render() {
            if (!dataCache) return;
            
            const q = document.getElementById('q').value.trim().toLowerCase();
            const gateSel = document.getElementById('gateFilter').value;
            let list = (dataCache.deliverables || []).slice();

            if (q) list = list.filter(d => matchQuery(d, q));
            if (gateSel) list = list.filter(d => (d.gate || 'Uncategorized') === gateSel);
            if (ownerFilter) {
                const key = ownerFilter.toLowerCase();
                list = list.filter(d => (d.assignees || []).some(a => (a || '').toLowerCase().includes(key)));
            }

            const grouped = byGate(list);
            const root = document.getElementById('root');
            root.innerHTML = '';

            const gatesToRender = dataCache.gates.filter(g => gateSel ? g.gate === gateSel : true);

            if (gatesToRender.length === 0) {
                root.innerHTML = `<div class="empty-state text-center py-16">
                    <div class="text-5xl mb-4">üîç</div>
                    <h3 class="text-xl font-semibold text-slate-300 mb-2">No deliverables found</h3>
                    <p class="text-sm text-slate-500">Try adjusting your filters or search query.</p>
                    <button onclick="clearFilters()" class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition-colors">
                        Clear Filters
                    </button>
                </div>`;
                return;
            }

            gatesToRender.forEach(gateInfo => {
                const itemsForThisGate = grouped[gateInfo.gate] || [];
                const statusGroups = byStatus(itemsForThisGate);
                const board = `
        <section>
          ${gateHeader(gateInfo.gate, gateInfo)}
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
            ${STATUS_ORDER.map(s => column(STATUS_TITLES[s], statusGroups[s], q)).join('')}
          </div>
        </section>
      `;
                root.insertAdjacentHTML('beforeend', board);
            });
        }

        // NEW: Clear filters function
        function clearFilters() {
            document.getElementById('q').value = '';
            document.getElementById('gateFilter').value = '';
            setOwnerFilter('');
        }

        // NEW: Export to CSV
        function exportToCSV() {
            if (!dataCache) return;
            
            let csv = 'Gate,Title,Status,Category,Critical,Assignees,Due Date,Priority\n';
            
            dataCache.deliverables.forEach(d => {
                const assignees = (d.assignees || []).join('; ');
                const dueDate = d.dueDate || 'N/A';
                const priority = d.priority || 'N/A';
                const critical = d.isCritical ? 'Yes' : 'No';
                
                csv += `"${d.gate}","${d.title}","${d.status}","${d.category}","${critical}","${assignees}","${dueDate}","${priority}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `deliverables-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function load() {
            try {
                const res = await fetch('/.netlify/functions/proxy');
                if (!res.ok) throw new Error(`Failed to load data: ${res.statusText}`);
                
                dataCache = await res.json();

                document.getElementById('loader').style.display = 'none';
                document.getElementById('root').classList.remove('hidden');

                const gatesFromData = (dataCache.gates || []).map(g => g.gate).sort();
                const sel = document.getElementById('gateFilter');
                sel.innerHTML = `<option value="">All gates</option>`;
                gatesFromData.forEach(g => sel.insertAdjacentHTML('beforeend', `<option>${g}</option>`));

                document.querySelectorAll('#ownerChips [data-owner]').forEach(btn => {
                    btn.addEventListener('click', () => setOwnerFilter(btn.dataset.owner));
                });

                const urlGate = new URLSearchParams(location.search).get('gate');
                if (urlGate && gatesFromData.includes(urlGate)) {
                    sel.value = urlGate;
                }

                const urlOwner = new URLSearchParams(location.search).get('owner');
                if (urlOwner) setOwnerFilter(urlOwner);

                render();
            } catch (err) {
                console.error("Load error:", err);
                const root = document.getElementById('root');
                root.classList.remove('hidden');
                document.getElementById('loader').style.display = 'none';
                
                // NEW: Better error display
                root.innerHTML = `<div class="flex items-center justify-center py-16">
                    <div class="card bg-red-900/20 p-8 max-w-md text-center border-red-700">
                        <div class="text-5xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-xl font-bold mb-3">Failed to Load Deliverables</h3>
                        <p class="text-sm text-slate-300 mb-6">${err.message}</p>
                        <button onclick="location.reload()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition-colors">
                            üîÑ Retry
                        </button>
                    </div>
                </div>`;
            }
        }

        // NEW: Debounced search
        document.getElementById('q').addEventListener('input', (e) => {
            clearTimeout(searchDebounce);
            searchDebounce = setTimeout(() => {
                render();
            }, 300); // Wait 300ms after user stops typing
        });

        document.getElementById('gateFilter').addEventListener('change', render);

        // NEW: Keyboard shortcut (Escape to clear search)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const searchInput = document.getElementById('q');
                if (searchInput.value) {
                    searchInput.value = '';
                    render();
                }
            }
        });

        load();
    </script>
</body>

</html>
